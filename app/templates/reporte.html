<!DOCTYPE html>
<html class="light" lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>SISGEM - Detalle de Emergencia</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800;900&amp;display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#005A9C",
            "secondary": "#2E7D32",
            "accent": "#FF8F00",
            "background-light": "#F4F6F8",
            "background-dark": "#212529",
            "text-light-primary": "#212529",
            "text-light-secondary": "#6C757D",
            "text-dark-primary": "#F4F6F8",
            "text-dark-secondary": "#6C757D",
          },
          fontFamily: {
            "display": ["Manrope", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
  <style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
  <div class="relative flex min-h-screen w-full flex-col">
    <header
      class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4 text-text-light-primary dark:text-text-dark-primary">
            <span class="material-symbols-outlined text-primary text-3xl">emergency_home</span>
            <h2 class="text-lg font-bold">SISGEM</h2>
          </div>
          <nav class="hidden md:flex flex-1 justify-center items-center gap-8">
            <a class="text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary hover:text-primary dark:hover:text-primary transition-colors"
              href="/">Inicio</a>
            <a class="text-sm font-medium text-text-light-secondary dark:text-text-dark-secondary hover:text-primary dark:hover:text-primary transition-colors"
              href="#">Registro</a>
            <a class="text-sm font-bold text-primary border-b-2 border-primary" href="#">Reporte</a>
          </nav>
          <div class="flex items-center relative">
            <button id="user-menu-button" aria-haspopup="true" aria-expanded="false" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-primary">
              <span class="material-symbols-outlined text-text-light-primary dark:text-text-dark-primary">person</span>
            </button>
            <!-- Dropdown -->
            <div id="user-menu" class="hidden absolute right-0 top-12 z-20 w-44 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-lg py-1">
              <div class="px-4 py-2 text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Cuenta</div>
              <a href="{{ url_for('auth.logout') }}" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                <span class="material-symbols-outlined text-base">logout</span>
                Salir
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex flex-wrap items-start justify-between gap-4 mb-8">
        {% if emergencia %}
        <div>
          <h1 class="text-text-light-primary dark:text-text-dark-primary text-4xl font-black tracking-tight mb-2">
            {{ emergencia.Nombre_emergencia }}</h1>
          <p class="text-text-light-secondary dark:text-text-dark-secondary">Reporte completo de emergencia</p>
        </div>
        {% else %}
        <h1 class="text-text-light-primary dark:text-text-dark-primary text-4xl font-black tracking-tight">
          Emergencia no encontrada</h1>
        {% endif %}
        <div class="flex gap-3">
          <a href="{{ url_for('emergencia.crear_emergencia') }}"
            class="flex items-center gap-2 px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors shadow">
            <span class="material-symbols-outlined">arrow_back</span>
            Volver
          </a>
          <button onclick="window.print()"
            class="flex items-center gap-2 px-6 py-3 bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 text-text-light-primary dark:text-text-dark-primary font-semibold rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors shadow">
            <span class="material-symbols-outlined">print</span>
            Imprimir
          </button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Columna Principal -->
        <div class="lg:col-span-2 flex flex-col gap-8">
          <!-- Detalles de la Emergencia -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <h2 class="text-text-light-primary dark:text-text-dark-primary text-2xl font-bold mb-6">
              Detalles de la Emergencia</h2>
            <div class="grid grid-cols-[140px_1fr] gap-x-6 gap-y-4 text-sm">
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">ID Emergencia</p>
              <p class="text-text-light-primary dark:text-text-dark-primary">{{ emergencia.id_emergencias if emergencia else '-' }}</p>
              
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">Estado Actual</p>
              <p class="text-text-light-primary dark:text-text-dark-primary">
                {% if emergencia %}
                <span class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-medium {{ estado_badge_classes }}">
                  <span class="size-1.5 rounded-full {{ estado_dot_class }}"></span>
                  {{ estado_display }}
                </span>
                {% else %}-{% endif %}
              </p>
              
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">Fecha Reporte</p>
              <p class="text-text-light-primary dark:text-text-dark-primary">
                {% if emergencia and emergencia.fecha_reporte %}{{ emergencia.fecha_reporte.strftime('%d/%m/%Y %H:%M') }}{% else %}-{% endif %}
              </p>
              
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">Fecha Cierre</p>
              <p class="text-text-light-primary dark:text-text-dark-primary">
                {% if emergencia and emergencia.fecha_cierre %}{{ emergencia.fecha_cierre.strftime('%d/%m/%Y %H:%M') }}{% else %}-{% endif %}
              </p>
              
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">Tipo</p>
              <p class="text-text-light-primary dark:text-text-dark-primary">{{ emergencia.tipo or '-' if emergencia else '-' }}</p>
              
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">Distrito</p>
              <p class="text-text-light-primary dark:text-text-dark-primary font-semibold">{{ emergencia.distrito or '-' if emergencia else '-' }}</p>
              
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">Dirección</p>
              <p class="text-text-light-primary dark:text-text-dark-primary">{{ emergencia.direccion or '-' if emergencia else '-' }}</p>
              
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium">Coordenadas</p>
              <p class="text-text-light-primary dark:text-text-dark-primary font-mono text-xs">
                {% if emergencia and emergencia.lat and emergencia.lon %}{{ emergencia.lat }}, {{ emergencia.lon }}{% else %}-{% endif %}
              </p>
            </div>
            
            <hr class="border-t border-gray-200 dark:border-gray-700 my-6" />
            
            <div>
              <p class="text-text-light-secondary dark:text-text-dark-secondary font-medium text-sm mb-2">Descripción</p>
              <p class="text-text-light-primary dark:text-text-dark-primary text-sm leading-relaxed">
                {% if emergencia %}{{ emergencia.descripcion or 'Sin descripción registrada.' }}{% else %}No se encontró la emergencia solicitada.{% endif %}
              </p>
            </div>
          </div>
          <!-- Recursos Desplegados -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <h2 class="text-text-light-primary dark:text-text-dark-primary text-2xl font-bold mb-6 flex items-center gap-2">
              <span class="material-symbols-outlined text-secondary">local_fire_department</span>
              Recursos Desplegados
            </h2>
            
            {% if total_bomberos > 0 or total_hidrantes > 0 %}
            <!-- Resumen de Recursos -->
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div class="bg-green-50 dark:bg-green-900/20 border-2 border-green-200 dark:border-green-700 rounded-lg p-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full bg-secondary/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-secondary text-2xl">local_fire_department</span>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-secondary">{{ total_bomberos }}</p>
                    <p class="text-sm text-text-light-secondary dark:text-text-dark-secondary">Estaciones de Bomberos</p>
                  </div>
                </div>
              </div>
              
              <div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-700 rounded-lg p-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-blue-600 text-2xl">water_drop</span>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-blue-600">{{ total_hidrantes }}</p>
                    <p class="text-sm text-text-light-secondary dark:text-text-dark-secondary">Hidrantes</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Lista de Bomberos -->
            {% if recursos_bomberos %}
            <div class="mb-6">
              <h3 class="text-lg font-bold text-text-light-primary dark:text-text-dark-primary mb-3">
                Estaciones de Bomberos ({{ recursos_bomberos|length }})
              </h3>
              <div class="space-y-2">
                {% for bombero in recursos_bomberos %}
                <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                  <span class="material-symbols-outlined text-secondary">local_fire_department</span>
                  <div class="flex-grow">
                    <p class="font-semibold text-sm text-text-light-primary dark:text-text-dark-primary">{{ bombero.direccion }}</p>
                    <p class="text-xs text-text-light-secondary dark:text-text-dark-secondary">ID: {{ bombero.entidad_recurso }}</p>
                  </div>
                  <span class="text-xs font-semibold text-secondary bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded">
                    {{ bombero.distancia_recurso }}
                  </span>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- Lista de Hidrantes -->
            {% if recursos_hidrantes %}
            <div>
              <h3 class="text-lg font-bold text-text-light-primary dark:text-text-dark-primary mb-3">
                Hidrantes ({{ recursos_hidrantes|length }})
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                {% for hidrante in recursos_hidrantes %}
                <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                  <span class="material-symbols-outlined text-blue-600 text-sm">water_drop</span>
                  <div class="flex-grow min-w-0">
                    <p class="font-medium text-xs text-text-light-primary dark:text-text-dark-primary truncate">{{ hidrante.direccion }}</p>
                  </div>
                  <span class="text-xs font-semibold text-blue-600 bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 rounded">
                    {{ hidrante.distancia_recurso }}
                  </span>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            {% else %}
            <div class="text-center py-8">
              <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600">info</span>
              <p class="mt-3 text-text-light-secondary dark:text-text-dark-secondary">No se han desplegado recursos para esta emergencia</p>
            </div>
            {% endif %}
          </div>
          <!-- Registro de Acciones -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <h2 class="text-text-light-primary dark:text-text-dark-primary text-2xl font-bold mb-6 flex items-center gap-2">
              <span class="material-symbols-outlined text-accent">assignment</span>
              Registro de Acciones
            </h2>
            
            {% if acciones %}
            <div class="flow-root">
              <ul class="-mb-8" role="list">
                {% for accion in acciones %}
                <li>
                  <div class="relative pb-8 {% if not loop.last %}border-l-2 border-gray-200 dark:border-gray-700 ml-4{% endif %}">
                    <div class="relative flex space-x-3 items-start">
                      <div class="-ml-4">
                        <span class="h-8 w-8 rounded-full bg-accent/20 flex items-center justify-center ring-4 ring-white dark:ring-gray-800">
                          {% if accion.tipo_accion == 'DESPLIEGUE_RECURSOS' %}
                          <span class="material-symbols-outlined text-accent text-lg">local_shipping</span>
                          {% elif accion.tipo_accion == 'ACTUALIZACION' %}
                          <span class="material-symbols-outlined text-accent text-lg">update</span>
                          {% else %}
                          <span class="material-symbols-outlined text-accent text-lg">note_add</span>
                          {% endif %}
                        </span>
                      </div>
                      <div class="min-w-0 flex-1 pt-1">
                        <div class="mb-1">
                          <span class="inline-block px-2 py-0.5 bg-accent/10 text-accent text-xs font-semibold rounded">
                            {{ accion.tipo_accion }}
                          </span>
                        </div>
                        <p class="text-sm text-text-light-primary dark:text-text-dark-primary whitespace-pre-wrap">{{ accion.descripcion_durante_emer }}</p>
                        <p class="mt-2 text-xs text-text-light-secondary dark:text-text-dark-secondary flex items-center gap-1">
                          <span class="material-symbols-outlined text-xs">schedule</span>
                          {% if accion.fecha_hora %}{{ accion.fecha_hora.strftime('%d/%m/%Y %H:%M:%S') }}{% else %}-{% endif %}
                        </p>
                      </div>
                    </div>
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% else %}
            <div class="text-center py-8">
              <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600">event_note</span>
              <p class="mt-3 text-text-light-secondary dark:text-text-dark-secondary">No se han registrado acciones para esta emergencia</p>
            </div>
            {% endif %}
          </div>
        </div>
        <!-- Columna Lateral -->
        <div class="lg:col-span-1 flex flex-col gap-8">
          <!-- Mapa de Ubicación -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
            <div class="p-6">
              <h2 class="text-text-light-primary dark:text-text-dark-primary text-xl font-bold mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined">location_on</span>
                Ubicación
              </h2>
            </div>
            {% if emergencia and emergencia.lat and emergencia.lon %}
            <div id="mapa-reporte" class="h-80 w-full"></div>
            {% else %}
            <div class="h-80 w-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
              <div class="text-center">
                <span class="material-symbols-outlined text-6xl text-gray-400 dark:text-gray-600">location_off</span>
                <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm mt-2">Sin coordenadas</p>
              </div>
            </div>
            {% endif %}
            <div class="p-6">
              {% if emergencia %}
              <div class="space-y-2">
                <div class="flex items-start gap-2">
                  <span class="material-symbols-outlined text-primary text-sm mt-0.5">home</span>
                  <div>
                    <p class="text-xs text-text-light-secondary dark:text-text-dark-secondary">Dirección</p>
                    <p class="text-sm font-medium text-text-light-primary dark:text-text-dark-primary">
                      {{ emergencia.direccion or 'Sin dirección registrada' }}
                    </p>
                  </div>
                </div>
                <div class="flex items-start gap-2">
                  <span class="material-symbols-outlined text-primary text-sm mt-0.5">location_city</span>
                  <div>
                    <p class="text-xs text-text-light-secondary dark:text-text-dark-secondary">Distrito</p>
                    <p class="text-sm font-semibold text-primary">
                      {{ emergencia.distrito or 'No especificado' }}
                    </p>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Resumen de Recursos -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <h2 class="text-text-light-primary dark:text-text-dark-primary text-xl font-bold mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined">summarize</span>
              Resumen
            </h2>
            
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                <div class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-secondary">local_fire_department</span>
                  <span class="text-sm font-medium text-text-light-primary dark:text-text-dark-primary">Bomberos</span>
                </div>
                <span class="text-lg font-bold text-secondary">{{ total_bomberos }}</span>
              </div>
              
              <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <div class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-blue-600">water_drop</span>
                  <span class="text-sm font-medium text-text-light-primary dark:text-text-dark-primary">Hidrantes</span>
                </div>
                <span class="text-lg font-bold text-blue-600">{{ total_hidrantes }}</span>
              </div>
              
              <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                <div class="flex items-center gap-2">
                  <span class="material-symbols-outlined text-accent">assignment</span>
                  <span class="text-sm font-medium text-text-light-primary dark:text-text-dark-primary">Acciones</span>
                </div>
                <span class="text-lg font-bold text-accent">{{ acciones|length if acciones else 0 }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // User menu toggle
    (function(){
      const btn = document.getElementById('user-menu-button');
      const menu = document.getElementById('user-menu');
      if(!btn || !menu) return;
      function closeMenu(){ menu.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); }
      function toggleMenu(){
        const open = menu.classList.contains('hidden');
        if(open){ menu.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); }
        else { closeMenu(); }
      }
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
      document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target !== btn){ closeMenu(); }});
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeMenu(); });
    })();
  </script>
  
  <!-- Script externo para el mapa -->
  <script src="{{ url_for('static', filename='js/reporte_mapa.js') }}"></script>
  
  {% if emergencia and emergencia.lat and emergencia.lon %}
  <!-- Datos para inicializar el mapa -->
  <script>
    /* eslint-disable */
    // @ts-nocheck
    document.addEventListener('DOMContentLoaded', function() {
      // Preparar datos de emergencia
      const emergenciaData = {
        lat: {{ emergencia.lat }},
        lon: {{ emergencia.lon }},
        nombre: {{ emergencia.Nombre_emergencia|tojson }},
        direccion: {{ emergencia.direccion|tojson }},
        distrito: {{ emergencia.distrito|tojson }}
      };
      
      // Preparar datos de bomberos
      const recursosBomberos = [
        {% if recursos_bomberos %}
        {% for bombero in recursos_bomberos %}
        {
          lat: {{ bombero.lat }},
          lon: {{ bombero.lon }},
          direccion: {{ bombero.direccion|tojson }},
          distancia_recurso: {{ bombero.distancia_recurso|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
      ];
      
      // Preparar datos de hidrantes
      const recursosHidrantes = [
        {% if recursos_hidrantes %}
        {% for hidrante in recursos_hidrantes[:10] %}
        {
          lat: {{ hidrante.lat }},
          lon: {{ hidrante.lon }},
          direccion: {{ hidrante.direccion|tojson }},
          distancia_recurso: {{ hidrante.distancia_recurso|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
      ];
      
      // Inicializar mapa
      inicializarMapaReporte(emergenciaData, recursosBomberos, recursosHidrantes);
    });
  </script>
  {% endif %}
</body>

</html>